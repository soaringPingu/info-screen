import sys# For handling of time and time zone informationimport datetime  # time of day etc.import pytz# imports related to web scrapingimport requestsimport jsonimport urllib.requestfrom PyQt5 import QtSvgfrom PyQt5.QtGui import QPixmapfrom bs4 import BeautifulSoup# Use PyQt5 to allow direct use of Qt UI filesfrom PyQt5.QtWidgets import QApplication, QMainWindow, QMessageBox, QGroupBox, QGridLayout, QLabelfrom PyQt5.QtCore import QTimer, QUrl# import the GUIfrom ui_gösta import Ui_MainWindow# Error logging facilitydef error_handling(error, message, window_handler=None):    # This function will write the error and message with    # a time stamp to a log file in the project root, unless    # another location is given in a config file.    # If the logging to file fails, then it will attempt to    # open a message box. If that also fails, then the error    # will be printed to the Python console.    log_file_name = "errors.log"    utc_now = pytz.utc.localize(datetime.datetime.utcnow())    now_se = utc_now.astimezone(pytz.timezone("Europe/Stockholm"))    time_stamp = now_se.strftime('%b %d %Y %H:%M:%S')    # Open the file in "append" mode and create the file if it does not exist    try:        with open(log_file_name, "a+") as log_file:            log_file.write(f"{time_stamp}\t | {error}\t | {message}\n")    except Exception as e:        if window_handler is None:            print("No window handler was passed to the error_handling function, and the log file failed.")            print(f"The error message was:\n{error}\n{message}")        else:            window_handler.msg = QMessageBox()            window_handler.msg.setIcon(QMessageBox.Warning)            window_handler.msg.setWindowTitle("Error log problem")            window_handler.msg.setText("There was a problem logging an error")            window_handler.msg.setInformativeText(f"{time_stamp}\nThe error I wanted to log was: \n{message}")            window_handler.msg.setDetailedText(f"The error while trying to log was:\n{str(e)}")            window_handler.msg.show()# Class handling bus time informationclass BusInformation:    def __init__(self, window_handler=None):        ######################################################################################        # Class to handle bus station information.                                           #        # It will look for a configuration file with bus line information and license key    #        # information. This will be in the project root                                      #        ######################################################################################        self.bus_stop_name = "Bus Stop"        self.bus_stop_id = -1        self.bus_line_number = -1        self.bus_start_location = "No start"        self.bus_end_location = "No end"        self.trafiklab_API_key_ResRobot_tidtabell = ""        self.trafiklab_API_key_ResRobot_reseplanerare = ""        self.trafiklab_API_key_GTFS = ""        self.window_handler = window_handler        self.read_config()        self.get_data()    def debug_print(self):        print(f"Bus stop: {self.bus_stop_name}")        print(f"Bus line number: {self.bus_line_number}")        print(f"Start location: {self.bus_start_location}")        print(f"End location: {self.bus_end_location}")        print(f"Tidtabell API Key: {self.trafiklab_API_key_ResRobot_tidtabell}")        print(f"Reseplanerare API key: {self.trafiklab_API_key_ResRobot_reseplanerare}")        print(f"GTFS API key: {self.trafiklab_API_key_GTFS}")    def get_data(self):        bus_departure = {"transport_type": "", "line": "", "time": ""}        departures = []        # From: https://www.trafiklab.se/api/resrobot-stolptidtabeller-2/dokumentation/avgaende-trafik        # Example        # https://api.resrobot.se/v2/departureBoard?key=<DIN NYCKEL>&id=<HÅLLPLATSID>&maxJourneys=<MAX ANTAL SVAR>        # More info on using API's in Python        # https://www.pythonforbeginners.com/python-on-the-web/how-to-access-various-web-services-in-python        # TEMP Find bus stop ID using Lat & Long        #url = f"https://api.resrobot.se/v2/location.nearbystops?key={self.trafiklab_API_key_ResRobot_reseplanerare}&originCoordLat=60.6531517&originCoordLong=15.7744094&format=xml"        #request = requests.get(url)        #print(request.text)        #try:        url = f"https://api.resrobot.se/v2/departureBoard?key={self.trafiklab_API_key_ResRobot_tidtabell}&id={self.bus_stop_id}&maxJourneys=5&format=json"        request = requests.get(url)        print(f">{request}>")        if str(request) == "<Response [200]>":   # We have a connection and some data            bus_data = json.loads(request.text) # returns a python data structure            print(bus_data)            # TODO We have the data, now we need to filter on buses heading towards Falun, set the number of changes            # Loop through the result.            count = 0            for item in bus_data["Departure"]:                # Filter out any bus lines that are not of interest                if item['transportNumber'] == self.bus_line_number:                    departures.append(bus_departure.copy())  # Add a departure dictionary                    if "Buss" in item['Product']['name']:                        departures[count]["transport_type"] = "Buss"                    elif "Taxi" in item['Product']['name']:                        departures[count]["transport_type"] = "Minibuss"                    departures[count]["line"] = item["transportNumber"]                    departures[count]["time"] = item["time"]                    departures[count]["direction"] = self.destination_name_filter(str(item["direction"]))                    print(departures[count])                    print()                    count += 1        self.display_data(departures)            # TODO get the current traffic info with live bus data        #except Exception as e:        #    print(str(e))            #error_handling(f"Error with ReseRobot API", f"Error message: {str(e)}", self.window_handler)    def destination_name_filter(self, destination):        # Run a number of replace functions on the destinations to replace a full name with a given name        if destination == "Falun Centralstation":            return "Falun C"        if destination == "Backafors (Falun kn)":            return "Backafors"        if destination == "Toftbyn (Falun kn)":            return "Toftbyn"        if destination == "Sundbornsskolan skolbusshållplats (Falun kn)":            return "Sundbornsskolan"        return destination    def display_data(self, bus_data):        # This routine will display the available bus data        # Set up two icons, one for a bus and one for a minibus using SVG graphics. From:        # https://stackoverflow.com/questions/35129102/simple-way-to-display-svg-image-in-a-pyqt-window#35138314        #svgWidget = QtSvg.QSvgWidget('Zeichen_123.svg')        #svgWidget.setGeometry(50, 50, 759, 668)        #svgWidget.show()        self.window_handler        bus_icon = QtSvg.QSvgWidget("ui/transport/Bus_white_30x30.svg")        bus_icon.setGeometry(300, 300, 330, 330)        bus_icon.show()        minibus_icon = QtSvg.QSvgWidget("ui/transport/Minibus_white_30x30.svg")        minibus_icon.setGeometry(500, 500, 530, 530)        minibus_icon.show()        #self.horizontalGroupBox = QGroupBox("Grid")        #layout = QGridLayout()        #layout.setColumnStretch(1, 4)        #layout.setColumnStretch(2, 4)        #layout.addWidget(QLabel('1'), 0, 0)        #layout.addWidget(QPixmap('2'), 0, 1)        #layout.addWidget(QPushButton('3'), 0, 2)        #layout.addWidget(QPushButton('4'), 1, 0)        #layout.addWidget(QPushButton('5'), 1, 1)        #layout.addWidget(QPushButton('6'), 1, 2)        #layout.addWidget(QPushButton('7'), 2, 0)        #layout.addWidget(QPushButton('8'), 2, 1)        #layout.addWidget(QPushButton('9'), 2, 2)        #self.horizontalGroupBox.setLayout(layout)    def read_config(self):        # Reads a configuration file, if there is one        config_file_name = "bus_info.cfg"        # Try to open the file and read all lines in it to a variable        # https://www.pythonforbeginners.com/files/reading-and-writing-files-in-python        try:            with open(config_file_name, "r") as bus_config:                data_lines = bus_config.readlines()                # loop through the lines and split the data. If it matches a property, read it                for line in data_lines:                    if line[0] != "#":              # Exclude comments                        temp_text = line.split("=")                        cfg_name = temp_text[0]                        cfg_data = temp_text[1]                        if len(temp_text) == 3:                            cfg_data_ext = temp_text[2]                        if cfg_name.strip() == "bus_stop":                            self.bus_stop_id = cfg_data.strip()                            self.bus_stop_name = cfg_data_ext.strip()                        if cfg_name.strip() == "bus_line_number":                            self.bus_line_number = cfg_data.strip()                        if cfg_name.strip() == "bus_start_location":                            self.bus_start_location = cfg_data.strip()                        if cfg_name.strip() == "bus_end_location":                            self.bus_end_location = cfg_data.strip()                        if cfg_name.strip() == "trafiklab_API_key_ResRobot_tidtabell":                            self.trafiklab_API_key_ResRobot_tidtabell = cfg_data.strip()                        if cfg_name.strip() == "trafiklab_API_key_ResRobot_reseplanerare":                            self.trafiklab_API_key_ResRobot_reseplanerare = cfg_data.strip()                        if cfg_name.strip() == "trafiklab_API_key_GTFS":                            self.trafiklab_API_key_GTFS = cfg_data.strip()            # "With" means file.close() is not required, it is automatic        except FileNotFoundError:            error_handling(f"Missing bus config file", f"Could not open the file \"{config_file_name}\"",                           self.window_handler)        except Exception as e:            error_handling(f"Error reading config file", f"Error message: {str(e)}", self.window_handler)class MainWindow(QMainWindow):    def __init__(self):        ######################################################################################        # Link to best information so far for connecting widgets to code:                    #        # https://ethicalhackingguru.com/getting-started-building-a-python-gui-using-pyqt5/  #        ######################################################################################        super(MainWindow, self).__init__()        self.ui = Ui_MainWindow()        self.ui.setupUi(self)        self.bus_information = BusInformation(self)        # Indicator that an error has occurred        self.active_fault = False        # Timers for fast and slow data updates        self.fast_timer = QTimer()        self.fast_timer.setInterval(500)  # 0.5 seconds        self.fast_timer.timeout.connect(self.update_data_fast)        #self.fast_timer.start()        self.slow_timer = QTimer()        self.slow_timer.setInterval(30000)  # 30 seconds        self.slow_timer.timeout.connect(self.update_data_slow)        #self.slow_timer.start()        self.quote_timer = QTimer()        self.quote_timer.setInterval(1000*60*60*6)  # every 6 hours [1 second * 60 seconds * 60 minutes * 6 hours]        self.quote_timer.timeout.connect(self.get_new_quote)        #self.quote_timer.start()        self.get_new_quote()    # Get initial quote    def update_data_fast(self):        days = ["Måndag", "Tisdag", "Onsdag", "Torsdag", "Fredag", "Lördag", "Söndag"]        months = ["Januari", "Februari", "Mars", "April", "Maj", "Juni", "Juli", "Augusti", "September", "Oktober",                  "November", "December"]        utc_now = pytz.utc.localize(datetime.datetime.utcnow())        now_se = utc_now.astimezone(pytz.timezone("Europe/Stockholm"))        now_nz = utc_now.astimezone(pytz.timezone("Pacific/Auckland"))        self.ui.se_time_label.setText(f"{now_se.hour}:{now_se.minute:02}:{now_se.second:02}")        self.ui.se_day_label.setText(f"{days[now_se.weekday()]}")        self.ui.se_date_label.setText(f"{now_se.day}")        self.ui.se_month_label.setText(f"{months[now_se.month - 1]}")        self.ui.se_occation_label.setText("En vanlig dag...")        self.ui.se_week_label.setText(f"v {now_se.strftime('%W')}")        self.ui.nz_time_label.setText(f"{now_nz.hour}:{now_nz.minute:02}")        self.ui.nz_day_label.setText(f"{days[now_nz.weekday()]}")        self.ui.nz_date_label.setText(f"{now_nz.day}")        self.ui.nz_month_label.setText(f"{months[now_nz.month - 1]}")        # TODO get the number of minutes left for a bus to arrive/leave    def update_data_slow(self):        # TODO get weather        # based on information from        # https://towardsdatascience.com/how-to-web-scrape-with-python-in-4-minutes-bc49186a8460        url_weather = "https://www.smhi.se/q/Sundborn/Falun/2670900"        response = requests.get(url_weather)        error_handling("An error occurred", "Extended error text", self)        if response == "200":            # Get the data            self.ui.temp_label.setText(f"Data finns!")        else:            self.ui.temp_label.setText(f"Ingen data")        self.bus_information.get_data()    def get_new_quote(self):        quote = "\"Imagine a problem is an apple and face it with a hungry attitude.\""        quotee = "Kaisa Wallner, 17:e Oktober, 2019"        temp_url = "https://adafruit.com"        response = requests.get(temp_url)        if str(response) == "<Response [200]>":            # Get the data            soup = BeautifulSoup(response.text, "html.parser")            # Get the quote            # get all span-tags            tags = soup("span")            # find the tag with the attribute class quoteClass (syntax found through commandline trial and error)            for tag in tags:                if str(tag.attrs) == "{'class': ['quoteClass']}":                    quote = tag.contents[0]            # Get the quotee            tags = soup("div")            # find the tag with the attribute class quoteClass (syntax found through commandline trial and error)            for tag in tags:                if str(tag.attrs) == "{'class': ['quoteAttribution']}":                    # The tag has two content parts, one line break [0], and one a-tag [1]. Parse the a-tag                    quotee = f"-{tag.contents[1].text}"        # set the labels        self.ui.quote_label.setText(quote)        self.ui.quotee_label.setText(quotee)        # adjust the sizes        self.ui.quote_label.adjustSize()        self.ui.quotee_label.adjustSize()        # Position the labels        self.ui.quotee_label.setGeometry(self.ui.quote_label.geometry().left(),                                         self.ui.quote_label.geometry().bottom() + 10,                                         self.ui.quote_label.geometry().width(),                                         self.ui.quote_label.geometry().height()                                         )if __name__ == "__main__":    app = QApplication(sys.argv)    window = MainWindow()    window.show()    sys.exit(app.exec_())